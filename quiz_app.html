<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quiz Control Panel</title>
  <style>
    :root{
      --bg:#0f1220; --card:#171a2b; --muted:#8fa1c7; --text:#e8ecf7;
      --accent:#6ea8fe; --accent2:#7ee787; --danger:#ff6b6b; --warn:#ffd166;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;
      color:var(--text);
      background:radial-gradient(1200px 600px at 20% -10%,#1e2240 0,#0f1220 60%), var(--bg);
      display:flex; justify-content:center; align-items:center; min-height:100vh;
      padding:20px;
    }
    .container{
      display:grid; grid-template-columns:1.2fr .8fr; gap:20px;
      width:min(1100px,100%);
    }
    .card{
      background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.1); border-radius:18px;
      padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.25);
      backdrop-filter:blur(6px);
    }
    h1{font-size:20px; margin:0}
    button, input[type=file], select{
      border:1px solid rgba(255,255,255,.16); background:#15192c; color:var(--text);
      padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600;
      transition:.15s ease;
    }
    button:hover{background:#1a2040}
    .accent{background:#13213e; border-color:rgba(110,168,254,.5)}
    .danger{background:#2a1111; border-color:rgba(255,107,107,.4)}
    .warn{background:#2b240e; border-color:rgba(255,209,102,.5)}
    .status{
      margin-top:10px; padding:10px 12px; border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:#10152a; color:var(--muted);
    }
    .status.good{color:var(--accent2); border-color:rgba(126,232,135,.35); background:#0f1a12}
    .status.bad{color:#ffb0b0; border-color:rgba(255,107,107,.35); background:#1f1212}
    .q-box{margin-top:10px; padding:14px; border-radius:14px; background:var(--card);}
    .opt{margin-top:8px; padding:10px; border-radius:10px; background:#121528;}
    #timerBox{
      margin-top:10px; padding:8px 12px; border-radius:12px;
      background:#12182f; border:1px solid rgba(126,232,135,.25);
      width:max-content; color:var(--accent2); font-weight:700;
    }
    #answerText{margin-top:8px; font-weight:700; color:var(--accent2);}
    table{width:100%; border-collapse:separate; border-spacing:0 8px;}
    th,td{padding:10px 12px; text-align:left}
    th{color:var(--muted)}
    tbody tr{background:var(--card)}
  </style>
</head>
<body>
  <div class="container">
    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
    <div class="card">
      <h1>–ü–∞–Ω–µ–ª—å –≤–µ–¥—É—â–µ–≥–æ</h1>

      <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ -->
      <div style="margin-top:10px;">
        <input type="file" id="fileInput" accept=".docx" />
        <button id="uploadBtn" class="accent">üìÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–æ–ø—Ä–æ—Å—ã</button>
      </div>

      <!-- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è -->
      <div style="margin-top:10px;">
        <input type="text" id="subjectInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É (–Ω–∞–ø—Ä–∏–º–µ—Ä: —Ñ–∏–∑–∏–∫–∞)" style="width:60%">
        <button id="genBtn" class="accent">üéì –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å AI-–≤–æ–ø—Ä–æ—Å—ã</button>
      </div>

      <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
      <div style="margin-top:10px;">
        <button id="nextBtn" class="accent">–°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å</button>
        <button id="resetBtn" class="danger">–°–±—Ä–æ—Å–∏—Ç—å –∏–≥—Ä—É</button>
      </div>

      <div id="statusBox" class="status">–û–∂–∏–¥–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π‚Ä¶</div>
      <div id="timerBox">‚è± –û—Å—Ç–∞–ª–æ—Å—å: <span id="timerText">‚Äî</span></div>

      <div class="q-box">
        <div id="questionText">–ù–∞–∂–º–∏—Ç–µ ¬´–°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å¬ª</div>
        <div id="optionsBox">
          <div class="opt" id="opt1">1) ‚Äî</div>
          <div class="opt" id="opt2">2) ‚Äî</div>
          <div class="opt" id="opt3">3) ‚Äî</div>
          <div class="opt" id="opt4">4) ‚Äî</div>
        </div>
        <div id="answerText"></div>
      </div>
    </div>

    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
    <div class="card">
      <h1>–¢–∞–±–ª–∏—Ü–∞ –æ—á–∫–æ–≤</h1>
      <table>
        <thead><tr><th>–ò–≥—Ä–æ–∫</th><th>–û—á–∫–∏</th></tr></thead>
        <tbody id="scoresBody"><tr><td class="muted">‚Äî</td><td class="muted">‚Äî</td></tr></tbody>
      </table>
    </div>
  </div>

  <script>
    const statusBox = document.getElementById("statusBox");
    const questionText = document.getElementById("questionText");
    const opts = [1,2,3,4].map(i => document.getElementById("opt"+i));
    const scoresBody = document.getElementById("scoresBody");
    const timerText = document.getElementById("timerText");
    const answerText = document.getElementById("answerText");

    let countdown = null;
    let timeLeft = 0;

    // === –¢–∞–π–º–µ—Ä ===
    function startTimer(seconds){
      if (countdown) clearInterval(countdown);
      timeLeft = seconds;
      timerText.textContent = `${timeLeft} —Å–µ–∫`;
      countdown = setInterval(()=>{
        timeLeft--;
        timerText.textContent = `${timeLeft} —Å–µ–∫`;
        if (timeLeft <= 0){
          clearInterval(countdown);
          timerText.textContent = "–í—Ä–µ–º—è –≤—ã—à–ª–æ!";
          showAnswer();
        }
      },1000);
    }

    // === –ü–æ–∫–∞–∑ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ ===
    async function showAnswer(){
      const res = await fetch("/answerkey");
      const data = await res.json();
      if (data.correct){
        answerText.textContent = `‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: ${data.correct}) ${data.text}`;
      } else {
        answerText.textContent = "–û—Ç–≤–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.";
      }
    }

    // === –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ ===
    document.getElementById("uploadBtn").onclick = async () => {
      const file = document.getElementById("fileInput").files[0];
      if (!file) return alert("–í—ã–±–µ—Ä–∏—Ç–µ .docx —Ñ–∞–π–ª!");
      const form = new FormData();
      form.append("file", file);
      statusBox.textContent = "‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...";
      const res = await fetch("/upload", { method: "POST", body: form });
      const data = await res.json();
      if (data.loaded) {
        statusBox.className="status good";
        statusBox.textContent = `‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${data.count} –≤–æ–ø—Ä–æ—Å–æ–≤ –∏–∑ —Ñ–∞–π–ª–∞`;
      } else {
        statusBox.className="status bad";
        statusBox.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞";
      }
    };

    // === –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ===
    document.getElementById("genBtn").onclick = async () => {
      const subj = document.getElementById("subjectInput").value.trim();
      if (!subj) return alert("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É!");
      statusBox.textContent = "ü§ñ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è...";
      const res = await fetch(`/generate?subject=${encodeURIComponent(subj)}`);
      const data = await res.json();
      if (data.generated) {
        statusBox.className="status good";
        statusBox.textContent = `‚úÖ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ ${data.count} –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ —Ç–µ–º–µ ¬´${subj}¬ª`;
      } else {
        statusBox.className="status bad";
        statusBox.textContent = "–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏";
      }
    };

    // === –°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å ===
    document.getElementById("nextBtn").onclick = async () => {
      const res = await fetch("/next");
      const data = await res.json();
      answerText.textContent = "";
      if (data.message){
        statusBox.className="status bad";
        statusBox.textContent = data.message;
        questionText.textContent = "‚Äî";
        opts.forEach((o,i)=>o.textContent=(i+1)+") ‚Äî");
        return;
      }
      questionText.textContent = data.question;
      data.options.forEach((t,i)=>opts[i].textContent=(i+1)+") "+t);
      statusBox.className="status";
      statusBox.textContent = `–í–æ–ø—Ä–æ—Å ${data.questionIndex+1}`;
      startTimer(data.time || 15);
    };

    // === –°–±—Ä–æ—Å ===
    document.getElementById("resetBtn").onclick = async () => {
      await fetch("/reset");
      statusBox.className="status";
      statusBox.textContent = "‚ôªÔ∏è –ò–≥—Ä–∞ —Å–±—Ä–æ—à–µ–Ω–∞";
      questionText.textContent="–ù–∞–∂–º–∏—Ç–µ ¬´–°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å¬ª";
      opts.forEach((o,i)=>o.textContent=(i+1)+") ‚Äî");
      timerText.textContent = "‚Äî";
      answerText.textContent = "";
    };

    // === –¢–∞–±–ª–∏—Ü–∞ –æ—á–∫–æ–≤ ===
    async function refreshScores(){
      const r = await fetch("/scores");
      const data = await r.json();
      const rows = Object.entries(data).sort((a,b)=>b[1]-a[1])
        .map(([p,s])=>`<tr><td>${p}</td><td>${s}</td></tr>`).join("");
      scoresBody.innerHTML = rows || `<tr><td class="muted">‚Äî</td><td class="muted">‚Äî</td></tr>`;
    }
    setInterval(refreshScores, 2000);
  </script>
</body>
</html>
